<!DOCTYPE html>
<html>
<head><meta charset="utf-8"><title>Patient Details</title>
<style>
body{font-family:Arial;background:#f6f8fa;padding:20px;}
.container{max-width:900px;margin:0 auto;background:#fff;padding:16px;border-radius:8px;border:1px solid #e6e6e6;}
.top{display:flex;justify-content:space-between;align-items:center;}
.btn{background:#0066cc;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;margin-left:6px;}
.btn.warn{background:#c0392b;}
section{margin-top:12px;}
label{font-weight:600;}
input, textarea, select{width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:4px;}
.table{width:100%;border-collapse:collapse;margin-top:8px;}
.table th, .table td{border:1px solid #ddd;padding:6px;text-align:left;vertical-align:top;}
.entry{border:1px solid #eee;padding:8px;border-radius:6px;margin-top:8px;background:#fafafa;}
.small{color:#555;font-size:0.95em;}
.inline{display:inline-block;vertical-align:middle;}
.diagnosisBox{display:flex;gap:8px;align-items:center;}
.linkbtn{background:transparent;border:1px dashed #0066cc;color:#0066cc;padding:6px;border-radius:6px;cursor:pointer;}
@media print {
  body * { visibility: hidden; }
  #printOnly, #printOnly * { visibility: visible; }
  #printOnly { position: absolute; left:0; top:0; width:100%;}
}
</style>
</head>
<body>
<div class="container">
  <div class="top">
    <div>
      <h2 id="title">Patient</h2>
      <div class="small" id="meta"></div>
      <!-- Diagnosis editable area -->
      <div style="margin-top:8px;">
        <label style="display:block;margin-bottom:4px">Diagnosis</label>
        <div id="diagDisplay" class="diagnosisBox">
          <div id="diagText" style="font-weight:700;color:#333;"></div>
          <button class="btn" id="editDiagBtn">Edit</button>
        </div>
        <div id="diagEdit" style="display:none;margin-top:6px;">
          <input id="diagInput" placeholder="Diagnosis">
          <div style="margin-top:6px;">
            <button class="btn" id="saveDiagBtn">Save</button>
            <button class="btn" id="cancelDiagBtn" style="background:#999">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <div>
      <button class="btn" onclick="location.href='index.html'">‚¨ÖÔ∏è Dashboard</button>
      <button class="btn" onclick="saveAll()">Save</button>
      <button class="btn" onclick="generate()">Generate Summary</button>
      <button class="btn" onclick="printSummary()">Print</button>
      <button class="btn" onclick="printSummaryOnly()">üñ®Ô∏è Print Final Summary Only</button>
      <button class="btn" onclick="openInvestigations()">Open Investigations Table</button>
    </div>
  </div>

  <section>
    <label>Chief Complaints</label>
    <textarea id="chief"></textarea>

    <label>History of Presenting Illness (HOPI)</label>
    <textarea id="hopi"></textarea>

    <label>diagnosis</label>
    <textarea id="hopi"></textarea>


    <div style="display:flex;gap:8px;">
      <div style="flex:1">
        <label>Date of Admission</label>
        <input id="doa" type="date">
      </div>
      <div style="flex:1">
        <label>Date of Discharge</label>
        <input id="dod" type="date">
      </div>
    </div>

    <label>Past History</label>
    <textarea id="past"></textarea>

    <label>Examination Findings</label>
    <textarea id="exam"></textarea>
  </section>

  <section>
    <h3>Plan of Action</h3>
    <textarea id="plan" placeholder="Plan: investigations, consults, procedures, dialysis etc."></textarea>
  </section>

  <section>
    <h3>Daily Progress Entries</h3>
    <label>New entry</label>
    <textarea id="newEntry"></textarea>
    <div style="display:flex;gap:8px;">
      <input id="entryDate" type="date">
      <button class="btn" onclick="addEntry()">Add Entry</button>
      <button class="btn" onclick="clearNew()">Clear</button>
    </div>
    <div id="entries"></div>
  </section>

  <section>
    <h3>Investigations</h3>
    <p class="small">You can add investigations as rows in the table below. You can also view the uploaded Investigations Chart (PDF) and uploaded discharge template.</p>
    <table class="table" id="invTable">
      <thead><tr><th>Date</th><th>Test</th><th>Result</th><th>Notes</th><th>Advice on discharge</th><th>Action</th></tr></thead>
      <tbody></tbody>
    </table>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
      <input id="invDate" type="date" style="width:140px;">
      <input id="invTest" placeholder="Test name" style="width:calc(100% - 520px);min-width:200px;">
      <input id="invResult" placeholder="Result" style="width:120px;">
      <input id="invNotes" placeholder="Notes" style="width:160px;">
      <input id="invAdvice" placeholder="Advice on discharge" style="width:200px;">
      <button class="btn" onclick="addInvestigation()">Add</button>
    </div>
    <div style="margin-top:10px;">
      <a href="assets/Investigations Chart.pdf" target="_blank">Preview Investigations Chart (uploaded PDF)</a><br>
      <a href="assets/pavithra.docx" target="_blank">Download uploaded discharge template (.docx)</a>
    </div>
  </section>

  <section>
    <h3>Treatment</h3>
    <textarea id="treatment"></textarea>
  </section>

  <section>
    <h3>Discharge Advice (overall)</h3>
    <textarea id="dischargeAdvice" placeholder="Advice to give on discharge: medications, follow-up, warnings etc."></textarea>
  </section>

  <h3>Printable Summary</h3>
  <pre id="summary" style="white-space:pre-wrap;border:1px solid #ddd;padding:10px;border-radius:6px;background:#fff;"></pre>
</div>

<script>
const id = new URLSearchParams(location.search).get('id');
let pts = JSON.parse(localStorage.getItem('patients')||'[]');
if(!pts[id]){ alert('Patient not found'); location='index.html'; }
let p = pts[id];

function init(){
  document.getElementById('title').innerText = p.name;
  renderMeta();
  document.getElementById('chief').value = (p.data.chief||'');
  document.getElementById('hopi').value = (p.data.hopi||'');
  document.getElementById('doa').value = p.data.doa||'';
  document.getElementById('dod').value = p.data.dod||'';
  document.getElementById('past').value = p.data.past||'';
  document.getElementById('exam').value = p.data.exam||'';
  document.getElementById('plan').value = p.data.plan||'';
  document.getElementById('treatment').value = p.data.treatment||'';
  document.getElementById('entryDate').value = new Date().toISOString().slice(0,10);
  document.getElementById('dischargeAdvice').value = p.data.dischargeAdvice || '';
  renderDiagnosisUI();
  renderEntries();
  renderInv();
  setupDiagButtons();
}

function renderMeta(){
  document.getElementById('meta').innerText = 'Age: ' + p.age + (p.meta?(' ‚Ä¢ '+p.meta):'');
}

function renderDiagnosisUI(){
  const diagText = document.getElementById('diagText');
  diagText.innerText = p.diagnosis || '(not specified)';
  document.getElementById('diagInput').value = p.diagnosis || '';
}

function setupDiagButtons(){
  document.getElementById('editDiagBtn').addEventListener('click', ()=> {
    document.getElementById('diagDisplay').style.display='none';
    document.getElementById('diagEdit').style.display='block';
  });
  document.getElementById('cancelDiagBtn').addEventListener('click', ()=> {
    document.getElementById('diagEdit').style.display='none';
    document.getElementById('diagDisplay').style.display='flex';
  });
  document.getElementById('saveDiagBtn').addEventListener('click', ()=> {
    const v = document.getElementById('diagInput').value.trim();
    p.diagnosis = v;
    pts[id] = p; localStorage.setItem('patients', JSON.stringify(pts));
    renderDiagnosisUI();
    document.getElementById('diagEdit').style.display='none';
    document.getElementById('diagDisplay').style.display='flex';
    alert('Diagnosis updated');
  });
}

function saveAll(){
  p.data.chief = document.getElementById('chief').value;
  p.data.hopi = document.getElementById('hopi').value;
  p.data.doa = document.getElementById('doa').value;
  p.data.dod = document.getElementById('dod').value;
  p.data.past = document.getElementById('past').value;
  p.data.exam = document.getElementById('exam').value;
  p.data.plan = document.getElementById('plan').value;
  p.data.treatment = document.getElementById('treatment').value;
  p.data.dischargeAdvice = document.getElementById('dischargeAdvice').value;
  pts[id]=p; localStorage.setItem('patients', JSON.stringify(pts));
  alert('Saved');
}

function addEntry(){
  const txt = document.getElementById('newEntry').value.trim();
  const date = document.getElementById('entryDate').value || new Date().toISOString().slice(0,10);
  if(!txt){ alert('Entry text required'); return; }
  p.data.entries = p.data.entries || [];
  p.data.entries.unshift({date:date, time: new Date().toLocaleTimeString(), text: txt});
  localStorage.setItem('patients', JSON.stringify(pts)); renderEntries(); document.getElementById('newEntry').value='';
}

function renderEntries(){
  const container = document.getElementById('entries');
  container.innerHTML = '';
  (p.data.entries||[]).forEach((e, i)=>{
    const div = document.createElement('div'); div.className='entry';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;"><div><b>${e.date}</b> ${e.time||''}</div>
                     <div><button class="btn warn" onclick="deleteEntry(${i})">Delete</button></div></div>
                     <div style="margin-top:6px;">${e.text.replace(/\n/g,'<br>')}</div>`;
    container.appendChild(div);
  });
}

function deleteEntry(i){ if(!confirm('Delete entry?')) return; p.data.entries.splice(i,1); localStorage.setItem('patients', JSON.stringify(pts)); renderEntries(); }

function addInvestigation(){
  const date = document.getElementById('invDate').value||new Date().toISOString().slice(0,10);
  const test = document.getElementById('invTest').value.trim();
  const result = document.getElementById('invResult').value.trim();
  const notes = document.getElementById('invNotes').value.trim();
  const advice = document.getElementById('invAdvice').value.trim();
  if(!test){ alert('Test name required'); return; }
  p.data.investigations = p.data.investigations || [];
  p.data.investigations.unshift({date, test, result, notes, advice});
  localStorage.setItem('patients', JSON.stringify(pts));
  renderInv();
  document.getElementById('invTest').value=''; document.getElementById('invResult').value=''; document.getElementById('invNotes').value=''; document.getElementById('invAdvice').value='';
}

function renderInv(){
  const tbody = document.querySelector('#invTable tbody');
  tbody.innerHTML = '';
  (p.data.investigations||[]).forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.test}</td><td>${r.result||''}</td><td>${r.notes||''}</td><td>${r.advice||''}</td>
                    <td><button class="btn warn" onclick="deleteInv(${i})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

function deleteInv(i){ if(!confirm('Delete investigation?')) return; p.data.investigations.splice(i,1); localStorage.setItem('patients', JSON.stringify(pts)); renderInv(); }

function generate(){
  saveAll();
  let s = `EAST POINT HOSPITAL
Department of General Medicine

Name: ${p.name}
Age: ${p.age}
${p.meta?('Unit/Info: '+p.meta+'\n'):''}
Diagnosis: ${p.diagnosis||''}

Chief Complaints:
${p.data.chief||''}

HOPI:
${p.data.hopi||''}

DOA: ${p.data.doa||''}    DOD: ${p.data.dod||''}

Past History:
${p.data.past||''}

Examination Findings:
${p.data.exam||''}

Plan of Action:
${p.data.plan||''}

Daily Progress Entries:

`;
  (p.data.entries||[]).slice().reverse().forEach(e=>{ s += `${e.date} ${e.time||''}
${e.text}

`; });
  s += `--- Investigations ---
`;
  (p.data.investigations||[]).forEach(i=>{ s += `${i.date} | ${i.test} | ${i.result||''} | ${i.notes||''} | Advice: ${i.advice||''}
`; });
  s += `
Treatment:
${p.data.treatment||''}

Discharge Advice:
${p.data.dischargeAdvice||''}

(Uploaded templates available in assets)`;
  document.getElementById('summary').innerText = s;
  return s;
}

function printSummary(){ generate(); window.print(); }

/* Print only the final summary: open new minimal window and print */
function printSummaryOnly(){
  const content = generate(); // ensure summary up to date
  const win = window.open('', '_blank', 'width=800,height=800');
  if(!win){ alert('Popup blocked. Allow popups and try again.'); return; }
  const html = `
    <!doctype html><html><head><meta charset="utf-8"><title>Final Summary - ${p.name}</title>
    <style>
      body{font-family:Arial;padding:20px;color:#111;}
      pre{white-space:pre-wrap;font-size:13px;border:0;}
      .header{font-weight:700;margin-bottom:10px;}
    </style>
    </head><body>
      <div class="header">EAST POINT HOSPITAL ‚Äî Final Summary</div>
      <pre>${escapeHtml(content)}</pre>
      <script>window.onload=function(){window.print(); setTimeout(()=>window.close(),500);}</script>
    </body></html>`;
  win.document.open();
  win.document.write(html);
  win.document.close();
}

/* helper to escape html for print window */
function escapeHtml(str){
  if(!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* open investigations page (vertical table). Pass patient id in query string. */
function openInvestigations(){
  // if the investigations folder/page exists in your project, this will open it
  const url = 'investigations/index.html?id=' + encodeURIComponent(id);
  window.open(url, '_blank');
}

/* small helpers */
function clearNew(){ document.getElementById('newEntry').value=''; }

/* initialize */
init();
</script>
</body>
</html>
