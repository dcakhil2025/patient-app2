<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Patient Details</title>
  <style>
    body{font-family:Arial;background:#f6f8fa;padding:20px;}
    .container{max-width:1100px;margin:0 auto;background:#fff;padding:16px;border-radius:8px;border:1px solid #e6e6e6;}
    .top{display:flex;justify-content:space-between;align-items:center;}
    .btn{background:#0066cc;color:#fff;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;margin-left:6px;}
    .btn.warn{background:#c0392b;}
    section{margin-top:12px;}
    label{font-weight:600;}
    input, textarea, select{width:100%;padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;}
    .table{width:100%;border-collapse:collapse;margin-top:8px;}
    .table th, .table td{border:1px solid #ddd;padding:6px;text-align:left;vertical-align:top;}
    .entry{border:1px solid #eee;padding:8px;border-radius:6px;margin-top:8px;background:#fafafa;}
    .small{color:#555;font-size:0.95em;}
    .diagnosisBox{display:flex;gap:8px;align-items:center;}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;}
    .inv-scroll{overflow:auto;}
    .date-pill{display:inline-block;padding:4px 8px;background:#eef;padding:4px;border-radius:4px;margin-right:6px;margin-bottom:6px;}
    pre#summary{white-space:pre-wrap;border:1px solid #ddd;padding:10px;border-radius:6px;background:#fff;}
    @media print {
      body * { visibility: hidden; }
      #printOnly, #printOnly * { visibility: visible; }
      #printOnly { position: absolute; left:0; top:0; width:100%; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="top">
    <div>
      <h2 id="title">Patient</h2>
      <div class="small" id="meta"></div>

      <!-- Diagnosis editable area -->
      <div style="margin-top:8px;">
        <label style="display:block;margin-bottom:4px">Diagnosis</label>
        <div id="diagDisplay" class="diagnosisBox">
          <div id="diagText" style="font-weight:700;color:#333;"></div>
          <button class="btn" id="editDiagBtn">Edit</button>
        </div>
        <div id="diagEdit" style="display:none;margin-top:6px;">
          <input id="diagInput" placeholder="Diagnosis">
          <div style="margin-top:6px;">
            <button class="btn" id="saveDiagBtn">Save</button>
            <button class="btn" id="cancelDiagBtn" style="background:#999">Cancel</button>
          </div>
        </div>
      </div>

    </div>

    <div>
      <button class="btn" onclick="location.href='index.html'">‚¨ÖÔ∏è Dashboard</button>
      <button class="btn" onclick="saveAll()">Save</button>
      <button class="btn" onclick="generate()">Generate Summary</button>
      <button class="btn" onclick="printSummary()">Print</button>
      <button class="btn" onclick="printSummaryOnly()">üñ®Ô∏è Print Final Summary Only</button>
    </div>
  </div>

  <section>
    <label>Chief Complaints</label>
    <textarea id="chief"></textarea>

    <label>History of Presenting Illness (HOPI)</label>
    <textarea id="hopi"></textarea>

    <div style="display:flex;gap:8px;">
      <div style="flex:1">
        <label>Date of Admission</label>
        <input id="doa" type="date">
      </div>
      <div style="flex:1">
        <label>Date of Discharge</label>
        <input id="dod" type="date">
      </div>
    </div>

    <label>Past History</label>
    <textarea id="past"></textarea>

    <label>Examination Findings</label>
    <textarea id="exam"></textarea>
  </section>

  <section>
    <h3>Plan of Action</h3>
    <textarea id="plan" placeholder="Plan: investigations, consults, procedures, dialysis etc."></textarea>
  </section>

  <section>
    <h3>Daily Progress Entries</h3>
    <label>New entry</label>
    <textarea id="newEntry"></textarea>
    <div style="display:flex;gap:8px;">
      <input id="entryDate" type="date">
      <button class="btn" onclick="addEntry()">Add Entry</button>
      <button class="btn" onclick="clearNew()">Clear</button>
    </div>
    <div id="entries"></div>
  </section>

  <!-- NEW: Investigations matrix embedded directly in patient page -->
  <section>
    <h3>Investigations (daily matrix)</h3>
    <p class="small">Add date columns and enter values for each test. Values are saved per patient.</p>

    <div class="controls">
      <button class="btn" onclick="addDateColumn()">‚ûï Add date column (YYYY-MM-DD)</button>
      <button class="btn" onclick="addTodayColumn()">‚ûï Add today column</button>
      <button class="btn" onclick="exportInvCSV()">‚¨áÔ∏è Export CSV</button>
      <button class="btn" onclick="saveInv()">üíæ Save</button>
      <span class="small">You can add / remove date columns. Row tests are fixed but you can add 'OTHERS' content.</span>
    </div>

    <div class="inv-scroll">
      <table class="table" id="invMatrix">
        <thead id="invHead"><tr><th>Test</th></tr></thead>
        <tbody id="invBody"></tbody>
      </table>
    </div>
    <p class="small">Tests included (vertical rows): Hb, total counts, platelets, urea, creatinine, Na, K, Cl, T.Bilirubin, D.Bilirubin, Protein, Albumin, AST, ALT, ALP, PT, APTT, INR, FLP, TSH, SEROLOGY, OTHERS</p>
  </section>

  <section>
    <h3>Treatment</h3>
    <textarea id="treatment"></textarea>
  </section>

  <section>
    <h3>Discharge Advice (overall)</h3>
    <textarea id="dischargeAdvice" placeholder="Advice to give on discharge: medications, follow-up, warnings etc."></textarea>
  </section>

  <h3>Printable Summary</h3>
  <pre id="summary"></pre>
</div>

<script>
/* ============================
   Initialization & data helpers
   ============================ */

const id = new URLSearchParams(location.search).get('id');
let pts = JSON.parse(localStorage.getItem('patients')||'[]');
if(!pts[id]){ alert('Patient not found'); location='index.html'; throw 'no patient'; }
let p = pts[id];

/* Use this tests list for the vertical rows */
const INV_TESTS = [
  "Hb","Total counts (TLC)","Platelets","Urea","Creatinine","Na","K","Cl",
  "Total Bilirubin","Direct Bilirubin","Protein","Albumin","AST","ALT","ALP",
  "PT","APTT","INR","FLP","TSH","SEROLOGY","OTHERS"
];

/* storage key helpers to namespace per patient */
function patientStorageKey(...parts){
  return ['patient', id, ...parts].join('|');
}

/* get and set for inv dates (array of date strings) */
function getInvDates(){
  return JSON.parse(localStorage.getItem(patientStorageKey('inv_dates'))||'[]');
}
function setInvDates(arr){
  localStorage.setItem(patientStorageKey('inv_dates'), JSON.stringify(arr));
}

/* get single cell */
function invCellKey(test, date){
  // safe key
  return patientStorageKey('inv', test, date);
}
function getInvValue(test, date){
  return localStorage.getItem(invCellKey(test,date)) || '';
}
function setInvValue(test, date, value){
  localStorage.setItem(invCellKey(test,date), String(value));
}

/* ============================
   UI rendering (diagnosis etc.)
   ============================ */

function init(){
  document.getElementById('title').innerText = p.name;
  renderMeta();
  document.getElementById('chief').value = p.data.chief || '';
  document.getElementById('hopi').value = p.data.hopi || '';
  document.getElementById('doa').value = p.data.doa || '';
  document.getElementById('dod').value = p.data.dod || '';
  document.getElementById('past').value = p.data.past || '';
  document.getElementById('exam').value = p.data.exam || '';
  document.getElementById('plan').value = p.data.plan || '';
  document.getElementById('treatment').value = p.data.treatment || '';
  document.getElementById('dischargeAdvice').value = p.data.dischargeAdvice || '';
  document.getElementById('entryDate').value = new Date().toISOString().slice(0,10);
  renderDiagnosisUI();
  renderEntries();
  renderInvMatrix();
  setupDiagButtons();
}

function renderMeta(){
  document.getElementById('meta').innerText = 'Age: ' + p.age + (p.meta?(' ‚Ä¢ '+p.meta):'');
}

/* Diagnosis editing UI */
function renderDiagnosisUI(){
  const diagText = document.getElementById('diagText');
  diagText.innerText = p.diagnosis || '(not specified)';
  document.getElementById('diagInput').value = p.diagnosis || '';
}

function setupDiagButtons(){
  document.getElementById('editDiagBtn').addEventListener('click', ()=> {
    document.getElementById('diagDisplay').style.display='none';
    document.getElementById('diagEdit').style.display='block';
  });
  document.getElementById('cancelDiagBtn').addEventListener('click', ()=> {
    document.getElementById('diagEdit').style.display='none';
    document.getElementById('diagDisplay').style.display='flex';
  });
  document.getElementById('saveDiagBtn').addEventListener('click', ()=> {
    const v = document.getElementById('diagInput').value.trim();
    p.diagnosis = v;
    pts[id] = p; localStorage.setItem('patients', JSON.stringify(pts));
    renderDiagnosisUI();
    document.getElementById('diagEdit').style.display='none';
    document.getElementById('diagDisplay').style.display='flex';
    alert('Diagnosis updated');
  });
}

/* ============================
   Saving & progress entries
   ============================ */

function saveAll(){
  p.data.chief = document.getElementById('chief').value;
  p.data.hopi = document.getElementById('hopi').value;
  p.data.doa = document.getElementById('doa').value;
  p.data.dod = document.getElementById('dod').value;
  p.data.past = document.getElementById('past').value;
  p.data.exam = document.getElementById('exam').value;
  p.data.plan = document.getElementById('plan').value;
  p.data.treatment = document.getElementById('treatment').value;
  p.data.dischargeAdvice = document.getElementById('dischargeAdvice').value;
  pts[id] = p;
  localStorage.setItem('patients', JSON.stringify(pts));
  alert('Saved');
}

function addEntry(){
  const txt = document.getElementById('newEntry').value.trim();
  const date = document.getElementById('entryDate').value || new Date().toISOString().slice(0,10);
  if(!txt){ alert('Entry text required'); return; }
  p.data.entries = p.data.entries || [];
  p.data.entries.unshift({date:date, time: new Date().toLocaleTimeString(), text: txt});
  pts[id] = p; localStorage.setItem('patients', JSON.stringify(pts)); renderEntries();
  document.getElementById('newEntry').value='';
}

function renderEntries(){
  const container = document.getElementById('entries');
  container.innerHTML = '';
  (p.data.entries||[]).forEach((e, i)=>{
    const div = document.createElement('div'); div.className='entry';
    div.innerHTML = `<div style="display:flex;justify-content:space-between;"><div><b>${e.date}</b> ${e.time||''}</div>
                     <div><button class="btn warn" onclick="deleteEntry(${i})">Delete</button></div></div>
                     <div style="margin-top:6px;">${e.text.replace(/\n/g,'<br>')}</div>`;
    container.appendChild(div);
  });
}
function deleteEntry(i){ if(!confirm('Delete entry?')) return; p.data.entries.splice(i,1); pts[id]=p; localStorage.setItem('patients', JSON.stringify(pts)); renderEntries(); }

function clearNew(){ document.getElementById('newEntry').value=''; }

/* ============================
   Investigations matrix UI
   ============================ */

function renderInvMatrix(){
  // header: Test + columns per date
  const dates = getInvDates();
  const head = document.getElementById('invHead');
  const body = document.getElementById('invBody');

  // build header row
  let headHtml = '<tr><th>Test</th>';
  dates.forEach((d, idx) => {
    headHtml += `<th>${escapeHtml(d)}<br><button class="btn warn" onclick="removeDateColumn(${idx})" title="Remove this date column">Remove</button></th>`;
  });
  headHtml += '</tr>';
  head.innerHTML = headHtml;

  // build body rows (tests)
  body.innerHTML = '';
  const tests = INV_TESTS;
  tests.forEach(t => {
    let row = `<tr><td style="min-width:220px;font-weight:600">${escapeHtml(t)}</td>`;
    dates.forEach(d => {
      const val = getInvValue(t, d);
      row += `<td><input style="width:100%;" data-test="${escapeHtml(t)}" data-date="${escapeHtml(d)}" value="${escapeAttribute(val)}" oninput="invCellChanged(this)"></td>`;
    });
    row += '</tr>';
    body.insertAdjacentHTML('beforeend', row);
  });
}

function addDateColumn(){
  const d = prompt('Enter date for column (YYYY-MM-DD):');
  if(!d) return;
  const dates = getInvDates();
  if(dates.includes(d)){ alert('Column already exists'); return; }
  dates.push(d);
  setInvDates(dates);
  renderInvMatrix();
}

function addTodayColumn(){
  const today = new Date().toISOString().slice(0,10);
  const dates = getInvDates();
  if(dates.includes(today)){ alert('Today column already exists'); return; }
  dates.push(today);
  setInvDates(dates);
  renderInvMatrix();
}

function removeDateColumn(idx){
  if(!confirm('Remove this date column and its saved values?')) return;
  const dates = getInvDates();
  const d = dates.splice(idx,1)[0];
  // remove saved values for that date
  INV_TESTS.forEach(t => {
    localStorage.removeItem(invCellKey(t,d));
  });
  setInvDates(dates);
  renderInvMatrix();
}

function invCellChanged(input){
  const test = input.dataset.test;
  const date = input.dataset.date;
  setInvValue(test, date, input.value);
}

function saveInv(){ 
  // values saved on input, but store a marker if needed
  localStorage.setItem(patientStorageKey('inv_saved_at'), new Date().toISOString());
  alert('Investigations saved for this patient');
}

/* Export CSV for investigations matrix */
function exportInvCSV(){
  const dates = getInvDates();
  let rows = [];
  rows.push(['Test', ...dates]);
  INV_TESTS.forEach(t => {
    const row = [t];
    dates.forEach(d => {
      row.push(getInvValue(t,d) || '');
    });
    rows.push(row);
  });
  const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `investigations_patient_${id}_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* helper escaping for attribute values */
function escapeAttribute(s){
  if(!s && s !== 0) return '';
  return String(s).replace(/"/g,'&quot;');
}
function escapeHtml(s){
  if(!s && s !== 0) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

/* ============================
   Summary generation (with default faculty)
   ============================ */

/* default faculty list - edit as needed */
const DEFAULT_FACULTY = [
  "Dr. Vidyasagar (HOD & Unit Head)",
  "Dr. Dinesh (Associate Professor)",
  "Dr. Kousar Begum (Assistant Professor)",
  "Dr. Saritha (Senior Resident)",
  "Dr. Nikhileshwar (Senior Resident)",
  "Dr. Chaitanya Akhil (Post Graduate)",
  "Dr. Chinmay (Post Graduate)"
];

function generate(){
  saveAll(); // ensure latest saved
  let s = `EAST POINT HOSPITAL\nDepartment of General Medicine\n\nName: ${p.name}\nAge: ${p.age}\n${p.meta?('Unit/Info: '+p.meta+'\n'):''}Diagnosis: ${p.diagnosis||''}\n\nChief Complaints:\n${p.data.chief||''}\n\nHOPI:\n${p.data.hopi||''}\n\nDOA: ${p.data.doa||''}    DOD: ${p.data.dod||''}\n\nPast History:\n${p.data.past||''}\n\nExamination Findings:\n${p.data.exam||''}\n\nPlan of Action:\n${p.data.plan||''}\n\nDaily Progress Entries:\n\n`;
  (p.data.entries||[]).slice().reverse().forEach(e=>{
    s += `${e.date} ${e.time||''}\n${e.text}\n\n`;
  });

  // Investigations matrix: print as header then rows
  s += `--- Investigations (matrix) ---\n`;
  const dates = getInvDates();
  if(dates.length === 0){
    s += "(No investigation date columns)\n";
  } else {
    // header line
    s += 'Test | ' + dates.join(' | ') + '\n';
    INV_TESTS.forEach(t=>{
      const rowvals = dates.map(d => (getInvValue(t,d) || '') );
      s += `${t} | ${rowvals.join(' | ')}\n`;
    });
  }

  s += `\nTreatment:\n${p.data.treatment||''}\n\nDischarge Advice:\n${p.data.dischargeAdvice||''}\n\n`;

  // Append default faculty
  s += 'DOCTORS:\n';
  DEFAULT_FACULTY.forEach(fn => s += fn + '\n');

  document.getElementById('summary').innerText = s;
  return s;
}

function printSummary(){ generate(); window.print(); }

/* Print only the final summary: open new minimal window and print */
function printSummaryOnly(){
  const content = generate(); // ensure summary up to date
  const win = window.open('', '_blank', 'width=900,height=800');
  if(!win){ alert('Popup blocked. Allow popups and try again.'); return; }
  const html = `
    <!doctype html><html><head><meta charset="utf-8"><title>Final Summary - ${escapeHtml(p.name)}</title>
    <style>
      body{font-family:Arial;padding:20px;color:#111;}
      pre{white-space:pre-wrap;font-size:13px;border:0;}
      .header{font-weight:700;margin-bottom:10px;}
    </style>
    </head><body>
      <div class="header">EAST POINT HOSPITAL ‚Äî Final Summary</div>
      <pre>${escapeHtml(content)}</pre>
      <script>window.onload=function(){window.print(); setTimeout(()=>window.close(),500);}</script>
    </body></html>`;
  win.document.open();
  win.document.write(html);
  win.document.close();
}

/* ============================
   Init call
   ============================ */

init();

</script>
</body>
</html>
